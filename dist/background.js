(()=>{"use strict";const t={categories:["Work","Social","Entertainment","Shopping","Other"],customCategories:{},retentionDays:30},a={activities:[],dailyStats:{},settings:t};class e{constructor(){}static getInstance(){return e.instance||(e.instance=new e),e.instance}async initialize(){await this.getData()||await this.setData(a)}async getData(){return new Promise((t=>{chrome.storage.local.get(null,(a=>{if(!(a&&a.activities&&a.dailyStats&&a.settings))return void t(null);const e={activities:a.activities,dailyStats:a.dailyStats,settings:a.settings};t(e)}))}))}async setData(t){return new Promise((a=>{chrome.storage.local.set(t,(()=>{a()}))}))}async addActivity(t){const a=await this.getData();if(!a)return;const e=(new Date).toISOString().split("T")[0];a.activities.push(t),a.dailyStats[e]||(a.dailyStats[e]={date:e,categories:{}});const i=a.dailyStats[e].categories[t.category]||{totalTime:0,visitCount:0};i.totalTime+=t.duration,i.visitCount+=1,a.dailyStats[e].categories[t.category]=i;const s=new Date;s.setDate(s.getDate()-a.settings.retentionDays);const n=s.toISOString().split("T")[0];a.activities=a.activities.filter((t=>new Date(t.startTime).toISOString().split("T")[0]>=n)),Object.keys(a.dailyStats).forEach((t=>{t<n&&delete a.dailyStats[t]})),await this.setData(a)}async getDailyStats(t){const a=await this.getData();return a?.dailyStats[t]||null}async getSettings(){const a=await this.getData();return a?.settings||t}async updateSettings(t){const a=await this.getData();a&&(a.settings={...a.settings,...t},await this.setData(a))}}let i=null;const s=e.getInstance();async function n(t){const a=await s.getSettings(),e=function(t){try{return new URL(t).hostname}catch{return"unknown"}}(t);return a.customCategories[e]?a.customCategories[e]:e.includes("github.com")||e.includes("gitlab.com")?"Work":e.includes("facebook.com")||e.includes("twitter.com")||e.includes("instagram.com")?"Social":e.includes("youtube.com")||e.includes("netflix.com")?"Entertainment":e.includes("amazon.com")||e.includes("ebay.com")?"Shopping":"Other"}async function c(t){if(!t.url||t.url.startsWith("chrome://"))return;const a={tabId:t.id.toString(),url:t.url,title:t.title,category:await n(t.url),startTime:t.startTime,duration:Date.now()-t.startTime};await s.addActivity(a)}async function r(t,a,e){i&&await c(i),i=a&&!a.startsWith("chrome://")?{id:t,url:a,title:e,startTime:Date.now()}:null}s.initialize().catch(console.error),chrome.tabs.onActivated.addListener((async t=>{const a=await chrome.tabs.get(t.tabId);a&&a.url&&a.title&&await r(a.id,a.url,a.title)})),chrome.tabs.onUpdated.addListener(((t,a,e)=>{"complete"===a.status&&e.active&&e.url&&e.title&&r(t,e.url,e.title).catch(console.error)})),chrome.windows.onFocusChanged.addListener((async t=>{if(t===chrome.windows.WINDOW_ID_NONE)i&&(await c(i),i=null);else{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});t&&t.id&&t.url&&t.title&&await r(t.id,t.url,t.title)}})),chrome.alarms.create("syncStats",{periodInMinutes:1}),chrome.alarms.onAlarm.addListener((async t=>{"syncStats"===t.name&&i&&(await c(i),i={...i,startTime:Date.now()})}))})();